image: node:11-alpine

variables:
  ENV: development
  POSTGRES_DB: rechat
  POSTGRES_USER: rechat
  POSTGRES_PASSWORD: rechat
  DATABASE_URL: "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres/$POSTGRES_DB"
  REDIS_URL: "redis://redis:6379"
  CONTAINER_IMAGE: registry.gitlab.com/rechat/server:$CI_COMMIT_REF_NAME

docker:
  stage: build
  only:
    - master
    - testing
    - develop

  script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
    - docker build -t $CONTAINER_IMAGE .
    - docker push $CONTAINER_IMAGE

modules:
  stage: build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  before_script:
    - apk --no-cache --update add git python build-base
    - npm install aglio --no-optional
    # We need aglio to generate docs.
    # The released version depends on protagonist which takes
    # a long time to build.
    # master version has a change (#272) that allows depending on draftjs
    # which has an optional dependency on protagonist and is therefore quick
    # to install.
  script:
    - NODE_ENV="$ENV" npm install
  tags:
    - docker

lint:
  stage: test
  dependencies:
    - modules
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull

  script: npx eslint .
  tags:
    - docker

coverage:
  stage: test
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull
  dependencies:
    - modules
  services:
    - alias: postgres
      name: mdillon/postgis:10-alpine
    - alias: redis
      name: redis:latest
  before_script:
    - apk --no-cache --update add postgresql-client
    - export PGPASSWORD=$POSTGRES_PASSWORD
    - psql -h "postgres" -U "$POSTGRES_USER" "$POSTGRES_DB" < ./data/minimal.sql
  script:
    - npm run coverage
  coverage: '/Lines\s+:\s([\d\.]+)/'
  artifacts:
    paths:
      - istanbul
      - docs
  tags:
    - docker

unit_coverage:
  stage: test
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
    policy: pull
  dependencies:
    - modules
  services:
    - alias: postgres
      name: mdillon/postgis:10-alpine
    - alias: redis
      name: redis:latest
  before_script:
    - apk --no-cache --update add postgresql-client
    - export PGPASSWORD=$POSTGRES_PASSWORD
    - psql -h "postgres" -U "$POSTGRES_USER" "$POSTGRES_DB" < ./data/minimal.sql
  script:
    - export ORIGINAL_NODE_ENV=production
    - export NODE_ENV=tests
    - npm run migrate:up
    - npm run coverage:unit
  coverage: '/Lines\s+:\s([\d\.]+)/'
  artifacts:
    paths:
      - istanbul
      - docs
  tags:
    - docker

docs:
  stage: deploy
  image: node:11-alpine
  only:
    - master
    - testing
    - develop

  dependencies:
    - modules
    - coverage
  cache:
    key: docs
    paths:
      - node_modules/
    policy: pull
  script:
    - node api_docs/index.js -o
  after_script:
    - apk --no-cache --update add ca-certificates wget
    - wget https://dl.minio.io/client/mc/release/linux-amd64/mc
    - chmod +x mc
    - ./mc config host add rechat https://minio.rechat.com "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
    - ./mc cp --recursive docs/ rechat/docs/$CI_COMMIT_REF_NAME
  tags:
    - docker
